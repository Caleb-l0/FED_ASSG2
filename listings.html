<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listings</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .listing { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
        img { max-width: 100px; display: block; margin-top: 5px; }
        #listings-container { margin-top: 20px; }
    </style>
</head>
<body>

    <h2>Listings</h2>
    <div id="user-info"></div>
    
    <!-- Login Form -->
    <div id="login-section">
        <input type="text" id="username" placeholder="Enter Username" required>
        <button id="login-btn">Login</button>
    </div>

    <form id="listing-form" style="display:none;">
        <input type="text" id="name" placeholder="Item Name" required>
        <input type="number" id="price" placeholder="Price" required>
        <input type="text" id="image" placeholder="Image URL">
        <button type="submit">Post Listing</button>
    </form>

    <div id="listings-container"></div>

    <script>
        const API_KEY = "678d1a12d31b8aa52a620cdc";
        const DB_NAME = "testing-80a6";
        const LISTINGS_URL = `https://${DB_NAME}.restdb.io/rest/listings`;
        
        document.addEventListener("DOMContentLoaded", () => {
            const username = localStorage.getItem("username");
            if (username) {
                document.getElementById("user-info").innerText = `Logged in as: ${username}`;
                document.getElementById("login-section").style.display = "none"; // Hide login section
                document.getElementById("listing-form").style.display = "block"; // Show listing form
                loadListings();
            } else {
                document.getElementById("login-section").style.display = "block"; // Show login section
            }

            document.getElementById("login-btn").addEventListener("click", () => {
                const usernameInput = document.getElementById("username").value.trim();
                if (usernameInput) {
                    localStorage.setItem("username", usernameInput);
                    document.getElementById("user-info").innerText = `Logged in as: ${usernameInput}`;
                    document.getElementById("login-section").style.display = "none"; // Hide login section
                    document.getElementById("listing-form").style.display = "block"; // Show listing form
                    loadListings();
                } else {
                    alert("Please enter a valid username.");
                }
            });

            document.getElementById("listing-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const name = document.getElementById("name").value;
                const price = parseFloat(document.getElementById("price").value); // Convert to number
                const image = document.getElementById("image").value;

                if (!name || isNaN(price)) {
                    alert("Name and valid Price are required!");
                    return;
                }

                const listing = {
                    name,
                    price,
                    image,
                    user: localStorage.getItem("username") // Use the current logged-in user
                };

                await postListing(listing);
                loadListings();
                e.target.reset();
            });
        });

        async function loadListings() {
            try {
                const response = await fetch(LISTINGS_URL, {
                    headers: { "x-apikey": API_KEY }
                });
                const listings = await response.json();
                
                // Filter listings to show only those posted by the current logged-in user
                const userListings = listings.filter(listing => listing.user === localStorage.getItem("username"));
                
                displayListings(userListings);
            } catch (error) {
                console.error("Error loading listings:", error);
            }
        }

        function displayListings(listings) {
            const container = document.getElementById("listings-container");
            container.innerHTML = "";
            listings.forEach(listing => {
                const div = document.createElement("div");
                div.classList.add("listing");
                div.innerHTML = `
                    <strong>${listing.name}</strong> - $${listing.price}
                    ${listing.image ? `<img src="${listing.image}" alt="Listing Image">` : ""}
                `;
                container.appendChild(div);
            });
        }

        async function postListing(listing) {
            try {
                const response = await fetch(LISTINGS_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-apikey": API_KEY
                    },
                    body: JSON.stringify(listing)
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(`Failed to post listing: ${response.statusText}, Details: ${JSON.stringify(errorDetails)}`);
                }
            } catch (error) {
                console.error("Error posting listing:", error);
            }
        }
    </script>

</body>
</html>
